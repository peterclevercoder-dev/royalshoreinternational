{% extends 'base.html' %}

{% block page_title %}Apply for Card{% endblock %}
{% block page_description %}Get your debit or credit card{% endblock %}

{% block extra_css %}
<style>
    /* Make sure select dropdowns show properly */
    select option {
        padding: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-6">
    <!-- Back Button -->
    <a href="{% url 'card_list' %}" class="inline-flex items-center text-sm text-gray-600 hover:text-blue-600 transition-colors">
        <i class="fas fa-arrow-left mr-2"></i>Back to Cards
    </a>

    <!-- Header -->
    <div class="text-center mb-8">
        <div class="w-16 h-16 bg-gradient-to-br from-blue-600 to-blue-700 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
            <i class="fas fa-credit-card text-white text-2xl"></i>
        </div>
        <h1 class="text-xl sm:text-2xl lg:text-3xl font-bold text-gray-900 mb-2">Apply for a New Card</h1>
        <p class="text-gray-600">Choose between debit or credit card</p>
    </div>

    <!-- Debug: Show form errors prominently -->
    {% if form.errors %}
    <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-6">
        <div class="flex items-start space-x-3">
            <i class="fas fa-exclamation-triangle text-blue-600 text-2xl mt-0.5"></i>
            <div class="flex-1">
                <h4 class="text-lg font-bold text-blue-900 mb-3">Form Errors Found:</h4>
                <div class="space-y-2">
                    {% for field, errors in form.errors.items %}
                        <div class="bg-white rounded p-3 border border-blue-300">
                            <p class="font-semibold text-blue-900 mb-1">
                                {% if field == '__all__' %}
                                    General Form Error:
                                {% else %}
                                    Field "{{ field }}":
                                {% endif %}
                            </p>
                            <ul class="text-sm text-blue-800 space-y-1 ml-4">
                                {% for error in errors %}
                                    <li>• {{ error }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Card Type Selection -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <div class="group cursor-pointer" onclick="selectCardType('DEBIT')">
            <div class="bg-white rounded-xl shadow-lg border-2 border-gray-200 p-4 sm:p-6 hover:border-blue-600 hover:shadow-xl transition-all duration-200 h-full">
                <!-- Debit Card Visual -->
                <div class="bg-gradient-to-br from-blue-600 to-blue-800 rounded-xl p-4 text-white mb-4 h-40 flex flex-col justify-between">
                    <div class="flex items-start justify-between">
                        <div>
                            <p class="text-xs opacity-80 mb-1">Debit Card</p>
                            <p class="text-sm font-semibold">Your Name</p>
                        </div>
                        <i class="fas fa-wifi text-lg"></i>
                    </div>
                    <div>
                        <p class="text-xl font-mono tracking-widest mb-2">•••• •••• •••• ••••</p>
                        <div class="flex justify-between items-end">
                            <span class="text-xs">MM/YY</span>
                            <span class="font-bold">VISA</span>
                        </div>
                    </div>
                </div>

                <h3 class="text-lg font-bold text-gray-900 mb-2">Debit Card</h3>
                <p class="text-sm text-gray-600 mb-4">Linked directly to your account for instant transactions</p>
                <ul class="space-y-2 text-xs text-gray-600">
                    <li class="flex items-center">
                        <i class="fas fa-check text-green-600 mr-2"></i>
                        No annual fee
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-check text-green-600 mr-2"></i>
                        ATM withdrawals
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-check text-green-600 mr-2"></i>
                        Online & POS transactions
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-check text-green-600 mr-2"></i>
                        Contactless payments
                    </li>
                </ul>
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <p class="text-xs text-gray-500">Activation Fee: <span class="font-semibold text-gray-900">$25.00</span></p>
                </div>
            </div>
        </div>

        <div class="group cursor-pointer" onclick="selectCardType('CREDIT')">
            <div class="bg-white rounded-xl shadow-lg border-2 border-gray-200 p-4 sm:p-6 hover:border-purple-600 hover:shadow-xl transition-all duration-200 h-full">
                <!-- Credit Card Visual -->
                <div class="bg-gradient-to-br from-purple-600 to-purple-800 rounded-xl p-4 text-white mb-4 h-40 flex flex-col justify-between">
                    <div class="flex items-start justify-between">
                        <div>
                            <p class="text-xs opacity-80 mb-1">Credit Card</p>
                            <p class="text-sm font-semibold">Your Name</p>
                        </div>
                        <i class="fas fa-wifi text-lg"></i>
                    </div>
                    <div>
                        <p class="text-xl font-mono tracking-widest mb-2">•••• •••• •••• ••••</p>
                        <div class="flex justify-between items-end">
                            <span class="text-xs">MM/YY</span>
                            <span class="font-bold">MasterCard</span>
                        </div>
                    </div>
                </div>

                <h3 class="text-lg font-bold text-gray-900 mb-2">Credit Card</h3>
                <p class="text-sm text-gray-600 mb-4">Build credit while enjoying flexible payments</p>
                <ul class="space-y-2 text-xs text-gray-600">
                    <li class="flex items-center">
                        <i class="fas fa-check text-green-600 mr-2"></i>
                        Credit limit up to $10,000
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-check text-green-600 mr-2"></i>
                        Rewards points
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-check text-green-600 mr-2"></i>
                        Purchase protection
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-check text-green-600 mr-2"></i>
                        Travel insurance
                    </li>
                </ul>
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <p class="text-xs text-gray-500">Activation Fee: <span class="font-semibold text-gray-900">$50.00</span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Application Form -->
    <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4 sm:p-8">
        <h2 class="text-xl font-bold text-gray-900 mb-6">Card Application</h2>
        
        <!-- Display All Form Errors -->
        {% if form.errors %}
        <div class="mb-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div class="flex items-start space-x-3">
                <i class="fas fa-exclamation-triangle text-blue-600 text-xl mt-0.5"></i>
                <div class="flex-1">
                    <h4 class="text-sm font-semibold text-blue-900 mb-2">Please correct the following errors:</h4>
                    <ul class="text-sm text-blue-800 space-y-1">
                        {% for field, errors in form.errors.items %}
                            {% for error in errors %}
                                <li>• {% if field != '__all__' %}{{ field }}: {% endif %}{{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        {% endif %}
        
        <form method="post" class="space-y-6">
            {% csrf_token %}
            
            <!-- Card Type -->
            <div>
                <label for="{{ form.card_type.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-credit-card text-blue-600 mr-2"></i>Card Type *
                </label>
                {{ form.card_type }}
                {% if form.card_type.errors %}
                    <p class="mt-2 text-sm text-blue-600 flex items-center">
                        <i class="fas fa-exclamation-circle mr-1"></i>
                        {{ form.card_type.errors.0 }}
                    </p>
                {% endif %}
                <p class="mt-1 text-xs text-gray-500">Select the type of card you want to apply for</p>
            </div>

            <!-- Linked Account -->
            <div>
                <label for="{{ form.account.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-link text-blue-600 mr-2"></i>Linked Account *
                </label>
                {{ form.account }}
                {% if form.account.errors %}
                    <p class="mt-2 text-sm text-blue-600 flex items-center">
                        <i class="fas fa-exclamation-circle mr-1"></i>
                        {{ form.account.errors.0 }}
                    </p>
                {% endif %}
                <p class="mt-1 text-xs text-gray-500">Choose the account to link with this card</p>
            </div>

            <!-- Card Name (Optional/Custom) -->
            <div>
                <label for="{{ form.card_name.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-tag text-blue-600 mr-2"></i>Card Name *
                </label>
                {{ form.card_name }}
                {% if form.card_name.errors %}
                    <p class="mt-2 text-sm text-blue-600 flex items-center">
                        <i class="fas fa-exclamation-circle mr-1"></i>
                        {{ form.card_name.errors.0 }}
                    </p>
                {% endif %}
                <p class="mt-1 text-xs text-gray-500">Give your card a custom name (e.g., "Personal Card", "Travel Card")</p>
            </div>

            <!-- Debug: Show what accounts are available -->
            {% if not form.account.field.queryset %}
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <div class="flex items-start space-x-3">
                    <i class="fas fa-exclamation-triangle text-yellow-600 text-xl mt-0.5"></i>
                    <div class="flex-1">
                        <h4 class="text-sm font-semibold text-yellow-900 mb-1">No Active Accounts</h4>
                        <p class="text-xs text-yellow-800">You need to have an active account before applying for a card. Please <a href="{% url 'account_apply' %}" class="font-semibold underline">open an account</a> first.</p>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Terms & Conditions (Using Django Form Field) -->
            <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
                <div class="flex items-start space-x-3">
                    <div class="flex items-center h-5">
                        {{ form.terms_accepted }}
                    </div>
                    <label for="{{ form.terms_accepted.id_for_label }}" class="text-sm text-gray-700 cursor-pointer">
                        I have read and agree to the <a href="#" class="text-blue-600 hover:text-blue-700 font-semibold">Card Terms and Conditions</a>, <a href="#" class="text-blue-600 hover:text-blue-700 font-semibold">Privacy Policy</a>, and understand the fees associated with this card.
                    </label>
                </div>
                {% if form.terms_accepted.errors %}
                    <p class="mt-2 text-sm text-blue-600 flex items-center">
                        <i class="fas fa-exclamation-circle mr-1"></i>
                        {{ form.terms_accepted.errors.0 }}
                    </p>
                {% endif %}
            </div>

            <!-- Important Information -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex items-start space-x-3">
                    <i class="fas fa-info-circle text-blue-600 text-xl mt-0.5"></i>
                    <div class="flex-1">
                        <h4 class="text-sm font-semibold text-blue-900 mb-2">Important Information</h4>
                        <ul class="text-xs text-blue-800 space-y-1">
                            <li>• Activation fee must be paid before card activation</li>
                            <li>• Your card will be delivered within 5-7 business days</li>
                            <li>• Set your PIN after receiving the card</li>
                            <li>• Keep your card details secure and never share them</li>
                            <li>• Report lost or stolen cards immediately</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Form Errors -->
            {% if form.non_field_errors %}
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex items-start space-x-3">
                    <i class="fas fa-exclamation-triangle text-blue-600 text-xl mt-0.5"></i>
                    <div class="flex-1">
                        {% for error in form.non_field_errors %}
                        <p class="text-sm text-blue-800">{{ error }}</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Submit Buttons -->
            <div class="flex flex-col sm:flex-row gap-4 pt-4">
                <button type="submit" class="flex-1 inline-flex items-center justify-center px-8 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg font-semibold shadow-lg hover:from-blue-700 hover:to-blue-800 transform hover:scale-105 transition-all duration-200">
                    <i class="fas fa-check mr-2"></i>
                    Submit Application
                </button>
                <a href="{% url 'card_list' %}" class="flex-1 inline-flex items-center justify-center px-8 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition-colors">
                    <i class="fas fa-times mr-2"></i>
                    Cancel
                </a>
            </div>
        </form>
    </div>

    <!-- FAQ Section -->
    <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
        <h3 class="text-lg font-bold text-gray-900 mb-4">Frequently Asked Questions</h3>
        <div class="space-y-4">
            <div>
                <h4 class="text-sm font-semibold text-gray-900 mb-1">How long does it take to get my card?</h4>
                <p class="text-xs text-gray-600">Your card will be delivered to your registered address within 5-7 business days after activation.</p>
            </div>
            <div>
                <h4 class="text-sm font-semibold text-gray-900 mb-1">Can I use my card internationally?</h4>
                <p class="text-xs text-gray-600">Yes, both debit and credit cards can be used worldwide wherever VISA/MasterCard is accepted.</p>
            </div>
            <div>
                <h4 class="text-sm font-semibold text-gray-900 mb-1">What if my card is lost or stolen?</h4>
                <p class="text-xs text-gray-600">Immediately block your card through the app or contact our 24/7 support hotline to prevent unauthorized transactions.</p>
            </div>
        </div>
    </div>
</div>

<script>
function selectCardType(type) {
    const cardTypeSelect = document.getElementById('{{ form.card_type.id_for_label }}');
    if (cardTypeSelect) {
        cardTypeSelect.value = type;
        // Visual feedback
        document.querySelectorAll('.group').forEach(el => {
            const div = el.querySelector('div');
            div.classList.remove('border-blue-600', 'border-purple-600', 'shadow-xl');
            div.classList.add('border-gray-200');
        });
        const selectedCard = event.currentTarget.querySelector('div');
        selectedCard.classList.remove('border-gray-200');
        selectedCard.classList.add(type === 'DEBIT' ? 'border-blue-600' : 'border-purple-600', 'shadow-xl');
    }
}
</script>

<style>
    select {
        @apply w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 text-gray-900 bg-white;
    }
    
    input[type="text"],
    input[type="email"] {
        @apply w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 text-gray-900;
    }
    
    input[type="checkbox"] {
        @apply w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500 cursor-pointer;
    }
</style>
{% endblock %}