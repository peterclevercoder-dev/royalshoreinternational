{% extends 'base.html' %}

{% block page_title %}Change Password{% endblock %}
{% block page_description %}Update your account password{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto space-y-6">
    <!-- Back Button -->
    <a href="{% url 'profile' %}" class="inline-flex items-center text-sm text-gray-600 hover:text-blue-600 transition-colors">
        <i class="fas fa-arrow-left mr-2"></i>Back to Profile
    </a>

    <!-- Header -->
    <div class="text-center mb-8">
        <div class="w-16 h-16 bg-gradient-to-br from-blue-600 to-blue-700 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
            <i class="fas fa-lock text-white text-2xl"></i>
        </div>
        <h1 class="text-xl sm:text-2xl lg:text-3xl font-bold text-gray-900 mb-2">Change Password</h1>
        <p class="text-gray-600">Update your account password for better security</p>
    </div>

    <!-- Show Form Errors -->
    {% if form.errors %}
    <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-6">
        <div class="flex items-start space-x-3">
            <i class="fas fa-exclamation-triangle text-blue-600 text-2xl mt-0.5"></i>
            <div class="flex-1">
                <h4 class="text-lg font-bold text-blue-900 mb-3">Form Errors Found:</h4>
                <div class="space-y-2">
                    {% for field, errors in form.errors.items %}
                        <div class="bg-white rounded p-3 border border-blue-300">
                            <p class="font-semibold text-blue-900 mb-1">
                                {% if field == '__all__' %}General Form Error:{% else %}Field "{{ field }}":{% endif %}
                            </p>
                            <ul class="text-sm text-blue-800 space-y-1 ml-4">
                                {% for error in errors %}
                                    <li>â€¢ {{ error }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Change Password Form -->
    <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4 sm:p-8">
        <form method="post" class="space-y-6">
            {% csrf_token %}

            <!-- Old Password -->
            <div>
                <label for="{{ form.old_password.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-key text-blue-600 mr-2"></i>Current Password *
                </label>
                <div class="relative">
                    {{ form.old_password }}
                    <button type="button" onclick="togglePassword('{{ form.old_password.id_for_label }}')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                        <i class="fas fa-eye" id="{{ form.old_password.id_for_label }}-icon"></i>
                    </button>
                </div>
                {% if form.old_password.errors %}
                    <p class="mt-2 text-sm text-blue-600"><i class="fas fa-exclamation-circle mr-1"></i>{{ form.old_password.errors.0 }}</p>
                {% endif %}
                <p class="mt-1 text-xs text-gray-500">Enter your current password to confirm changes</p>
            </div>

            <!-- New Password -->
            <div>
                <label for="{{ form.new_password1.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-lock text-blue-600 mr-2"></i>New Password *
                </label>
                <div class="relative">
                    {{ form.new_password1 }}
                    <button type="button" onclick="togglePassword('{{ form.new_password1.id_for_label }}')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                        <i class="fas fa-eye" id="{{ form.new_password1.id_for_label }}-icon"></i>
                    </button>
                </div>
                {% if form.new_password1.errors %}
                    <p class="mt-2 text-sm text-blue-600"><i class="fas fa-exclamation-circle mr-1"></i>{{ form.new_password1.errors.0 }}</p>
                {% endif %}

                <!-- Password Strength Indicator -->
                <div class="mt-3">
                    <div class="flex items-center space-x-2 mb-2">
                        <div class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
                            <div id="password-strength-bar" class="h-full w-0 transition-all duration-300"></div>
                        </div>
                        <span id="password-strength-text" class="text-xs font-semibold"></span>
                    </div>
                    <p class="text-xs text-gray-600">Password must be at least 8 characters long</p>
                </div>
            </div>

            <!-- Confirm New Password -->
            <div>
                <label for="{{ form.new_password2.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-lock text-blue-600 mr-2"></i>Confirm New Password *
                </label>
                <div class="relative">
                    {{ form.new_password2 }}
                    <button type="button" onclick="togglePassword('{{ form.new_password2.id_for_label }}')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                        <i class="fas fa-eye" id="{{ form.new_password2.id_for_label }}-icon"></i>
                    </button>
                </div>
                {% if form.new_password2.errors %}
                    <p class="mt-2 text-sm text-blue-600"><i class="fas fa-exclamation-circle mr-1"></i>{{ form.new_password2.errors.0 }}</p>
                {% endif %}
                <p class="mt-1 text-xs text-gray-500">Re-enter your new password</p>
            </div>

            <!-- Password Requirements -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex items-start space-x-3">
                    <i class="fas fa-shield-alt text-blue-600 text-xl mt-0.5"></i>
                    <div class="flex-1">
                        <h4 class="text-sm font-semibold text-blue-900 mb-2">Password Requirements</h4>
                        <ul class="text-xs text-blue-800 space-y-1">
                            <li id="req-length" class="flex items-center"><i class="fas fa-circle text-xs mr-2"></i>At least 8 characters long</li>
                            <li id="req-uppercase" class="flex items-center"><i class="fas fa-circle text-xs mr-2"></i>Contains uppercase letter (A-Z)</li>
                            <li id="req-lowercase" class="flex items-center"><i class="fas fa-circle text-xs mr-2"></i>Contains lowercase letter (a-z)</li>
                            <li id="req-number" class="flex items-center"><i class="fas fa-circle text-xs mr-2"></i>Contains number (0-9)</li>
                            <li id="req-special" class="flex items-center"><i class="fas fa-circle text-xs mr-2"></i>Contains special character (!@#$%^&*)</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Submit Buttons -->
            <div class="flex flex-col sm:flex-row gap-4 pt-4">
                <button type="submit" class="flex-1 px-8 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg font-semibold hover:from-blue-700 hover:to-blue-800 transition-colors">
                    <i class="fas fa-save mr-2"></i>Change Password
                </button>
                <a href="{% url 'profile' %}" class="flex-1 px-8 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition-colors text-center">
                    <i class="fas fa-times mr-2"></i>Cancel
                </a>
            </div>
        </form>
    </div>

    <!-- Security Tips -->
    <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
        <h3 class="text-lg font-bold text-gray-900 mb-4">Security Tips</h3>
        <ul class="space-y-2 text-sm text-gray-700">
            <li class="flex items-start">
                <i class="fas fa-check text-green-600 mr-2 mt-1"></i>
                <span>Use a unique password that you don't use anywhere else</span>
            </li>
            <li class="flex items-start">
                <i class="fas fa-check text-green-600 mr-2 mt-1"></i>
                <span>Avoid using personal information like names or birthdays</span>
            </li>
            <li class="flex items-start">
                <i class="fas fa-check text-green-600 mr-2 mt-1"></i>
                <span>Change your password regularly (every 3-6 months)</span>
            </li>
            <li class="flex items-start">
                <i class="fas fa-check text-green-600 mr-2 mt-1"></i>
                <span>Never share your password with anyone</span>
            </li>
            <li class="flex items-start">
                <i class="fas fa-check text-green-600 mr-2 mt-1"></i>
                <span>Enable two-factor authentication for extra security</span>
            </li>
        </ul>
    </div>
</div>

<script>
// Toggle password visibility
function togglePassword(fieldId) {
    const field = document.getElementById(fieldId);
    const icon = document.getElementById(fieldId + '-icon');
    
    if (field.type === 'password') {
        field.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        field.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

// Password strength checker
const newPasswordField = document.getElementById('{{ form.new_password1.id_for_label }}');
if (newPasswordField) {
    newPasswordField.addEventListener('input', function() {
        const password = this.value;
        const strengthBar = document.getElementById('password-strength-bar');
        const strengthText = document.getElementById('password-strength-text');
        
        let strength = 0;
        const requirements = {
            length: password.length >= 8,
            uppercase: /[A-Z]/.test(password),
            lowercase: /[a-z]/.test(password),
            number: /[0-9]/.test(password),
            special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
        };
        
        // Update requirement indicators
        document.getElementById('req-length').className = requirements.length ? 'flex items-center text-green-600' : 'flex items-center';
        document.getElementById('req-uppercase').className = requirements.uppercase ? 'flex items-center text-green-600' : 'flex items-center';
        document.getElementById('req-lowercase').className = requirements.lowercase ? 'flex items-center text-green-600' : 'flex items-center';
        document.getElementById('req-number').className = requirements.number ? 'flex items-center text-green-600' : 'flex items-center';
        document.getElementById('req-special').className = requirements.special ? 'flex items-center text-green-600' : 'flex items-center';
        
        // Calculate strength
        Object.values(requirements).forEach(req => {
            if (req) strength++;
        });
        
        // Update strength bar
        const percentage = (strength / 5) * 100;
        strengthBar.style.width = percentage + '%';
        
        if (strength === 0) {
            strengthBar.className = 'h-full transition-all duration-300';
            strengthText.textContent = '';
        } else if (strength <= 2) {
            strengthBar.className = 'h-full bg-blue-500 transition-all duration-300';
            strengthText.textContent = 'Weak';
            strengthText.className = 'text-xs font-semibold text-blue-600';
        } else if (strength <= 3) {
            strengthBar.className = 'h-full bg-yellow-500 transition-all duration-300';
            strengthText.textContent = 'Fair';
            strengthText.className = 'text-xs font-semibold text-yellow-600';
        } else if (strength <= 4) {
            strengthBar.className = 'h-full bg-blue-500 transition-all duration-300';
            strengthText.textContent = 'Good';
            strengthText.className = 'text-xs font-semibold text-blue-600';
        } else {
            strengthBar.className = 'h-full bg-green-500 transition-all duration-300';
            strengthText.textContent = 'Strong';
            strengthText.className = 'text-xs font-semibold text-green-600';
        }
    });
}
</script>

<style>
    input[type="password"], input[type="text"] {
        @apply w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 text-gray-900;
    }
</style>
{% endblock %}